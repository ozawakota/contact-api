# Cloud Run functions (補助的な処理) でやるべきこと

特定のイベントをトリガーにした「切り離せる処理」を担当させます。

具体例:

* レポート生成: 管理者が「月間のお問い合わせ統計PDF」をリクエストした際、その生成処理をFunctionsに投げる。

* Embeddingの一括更新: 大量の過去データをベクトルDB（pgvector）に再登録するバッチ処理。

* 外部連携通知: 振り分けが決まった後、Slackや外部CRMへの通知だけを非同期で行う。


## 検討

Google Cloud Pub/Sub 

Pub/Subは、データを送る側と受け取る側を**「直接つながない（疎結合）」**のが最大の特徴です。

## 🚀 なぜ今回のお問い合わせAPIで使うのか？
直接「FastAPIからFunctionsを呼ぶ」のではなく、間にPub/Subを挟むのには3つの大きな理由があります。

  1. レスポンス速度の向上（ユーザーを待たせない）
AIの解析が終わった後、「メール送信」や「外部システム連携」に時間がかかると、ユーザーの画面は止まったままになります。

 Pub/Subあり: 「解析完了！あとはPub/Subに投げたから、画面には『受付完了』を出そう」と、一瞬でレスポンスを返せます。

  2. 負荷の分散と平準化
キャンペーンなどで一度に1,000件のお問い合わせが殺到したとします。

Pub/Subなし: APIサーバーやメールサーバーがパンクしてダウンする可能性があります。

Pub/Subあり: Pub/Subがメッセージを溜めておいてくれるので、受信側のFunctionsが自分のペースで1件ずつ確実に処理できます。

  3. 耐障害性（リトライの自動化）
もしメールサーバーが一時的にメンテナンスで落ちていても、Pub/Subはメッセージを保持し続け、メールサーバーが復活した瞬間に再送してくれます。